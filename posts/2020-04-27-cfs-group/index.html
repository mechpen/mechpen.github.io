<!DOCTYPE html><html><head>
    <meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<title>Linux CFS and task group – Mechpen</title>


<link rel="icon" type="image/png" href="/assets/favicon.png">
<link rel="stylesheet" href="/assets/style.css">

    
    
    <link href="/assets/prism.css" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" rel="stylesheet">
    
  </head>

  <body>
    <div>
      <div class="container">
        <header class="masthead clearfix">
          <div class="site-info">
            <a href="/" class="site-name">Mechpen</a>
          </div>
          <nav>
	    <a href="/">posts</a>
	    <a href="/notes">notes</a>
	    <a href="/about">about</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <div class="post">
  <h1>Linux CFS and task group</h1>

  <div class="date">
    April 27, 2020
  </div>

  <div class="entry">
    <p>
I dived into the kernel scheduler code under
<code>kernel/sched/</code> to understand how CFS works and how the
task group <code>cpu.shares</code> value is used in CFS.
</p>
    <p><strong>Update</strong> [Jul/21]: Added info for cgroup v2 in section 3.2.</p>
<h2 id="1.-cfs-concepts" tabindex="-1"><a class="header-anchor" href="#1.-cfs-concepts">1. CFS concepts</a></h2>
<p>In CFS, every running entity, a process or a task group, has a virtual
runtime (<code>vruntime</code>) which accounts for the entity's CPU usage. The
scheduling goal of CFS is to keep the <code>vruntime</code> of all running
entities to be the same.</p>
<p>The <code>vruntime</code> of an entity is calculated by dividing the physical run
time of the entity with a weight factor.  Assume a CPU has <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span> running
entities.  Entity <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span> has weight <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> and CPU time <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.61508em;"></span><span class="strut bottom" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">i=1, 2,
..., n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">2</span><span class="mpunct">,</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mpunct">,</span><span class="mord mathit">n</span></span></span></span> then</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext><mi mathvariant="normal">v</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi></mtext><mo>=</mo><mfrac><mrow><msub><mi>t</mi><mn>1</mn></msub></mrow><mrow><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac><mo>=</mo><mfrac><mrow><msub><mi>t</mi><mn>2</mn></msub></mrow><mrow><msub><mi>w</mi><mn>2</mn></msub></mrow></mfrac><mo>=</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>=</mo><mfrac><mrow><msub><mi>t</mi><mi>n</mi></msub></mrow><mrow><msub><mi>w</mi><mi>n</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{vruntime} = \frac{t_1}{w_1} = \frac{t_2}{w_2} = ... = \frac{t_n}{w_n}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.29208em;"></span><span class="strut bottom" style="height:2.1280799999999997em;vertical-align:-0.8360000000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm" style="margin-right:0.01389em;">v</span><span class="mord mathrm">r</span><span class="mord mathrm">u</span><span class="mord mathrm">n</span><span class="mord mathrm">t</span><span class="mord mathrm">i</span><span class="mord mathrm">m</span><span class="mord mathrm">e</span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>For any time period <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span>, we have:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><mrow><mo>∑</mo><mi>w</mi></mrow></mfrac><mi>T</mi></mrow><annotation encoding="application/x-tex">t_i = \frac{w_i}{\sum w}T
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.10756em;"></span><span class="strut bottom" style="height:2.04357em;vertical-align:-0.93601em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">∑</span><span class="mord mathit" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>Thus the allocated CPU time of an entity is proportional to its weight.</p>
<h2 id="2.-implementation" tabindex="-1"><a class="header-anchor" href="#2.-implementation">2. Implementation</a></h2>
<h3 id="2.1.-nice-level%2C-priority-and-weight" tabindex="-1"><a class="header-anchor" href="#2.1.-nice-level%2C-priority-and-weight">2.1. Nice level, priority and weight</a></h3>
<p>User can change the nice level of a process with the <code>nice()</code> syscall
or the <code>setpriority()</code> syscall.  nice levels are mapped to priority
values using the macro <code>NICE_TO_PRIO()</code>, and priority values are
mapped to weights using the lookup table <code>sched_prio_to_weight</code>.  The
following table shows these mappings:</p>
<table>
<thead>
<tr>
<th>nice level</th>
<th>priority</th>
<th>weight</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>2</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">-20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord">−</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span> (min)</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>8</mn><mn>8</mn><mn>7</mn><mn>6</mn><mn>1</mn><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mn>2</mn><mn>0</mn></mrow></msup></mrow><annotation encoding="application/x-tex">88761 \approx 1024 \times 1.25^{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">8</span><span class="mord mathrm">8</span><span class="mord mathrm">7</span><span class="mord mathrm">6</span><span class="mord mathrm">1</span><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>∈</mo><mo>[</mo><mo>−</mo><mn>1</mn><mn>9</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">n\in[-19, -1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">∈</span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mpunct">,</span><span class="mord">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>2</mn><mn>0</mn><mo>+</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">120 + n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathit">n</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mo>−</mo><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\approx 1024 \times 1.25^{-n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.771331em;"></span><span class="strut bottom" style="height:0.854661em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">0</span></span></span></span> (default)</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>2</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">120</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><annotation encoding="application/x-tex">1024</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>∈</mo><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mn>8</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">n\in[1, 18]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">∈</span><span class="mopen">[</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">1</span><span class="mord mathrm">8</span><span class="mclose">]</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>2</mn><mn>0</mn><mo>+</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">120 + n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathit">n</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mo>−</mo><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\approx 1024 \times 1.25^{-n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.771331em;"></span><span class="strut bottom" style="height:0.854661em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>9</mn></mrow><annotation encoding="application/x-tex">19</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">9</span></span></span></span> (max)</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>3</mn><mn>9</mn></mrow><annotation encoding="application/x-tex">139</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">3</span><span class="mord mathrm">9</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>5</mn><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mo>−</mo><mn>1</mn><mn>9</mn></mrow></msup></mrow><annotation encoding="application/x-tex">15 \approx 1024 \times 1.25^{-19}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">5</span><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
</tbody>
</table>
<p>The comment above <code>sched_prio_to_weight</code> explains why 1.25 is used as
the base for weight calculation:</p>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">/*
 * Nice levels are multiplicative, with a gentle 10% change for every
 * nice level changed. I.e. when a CPU-bound task goes from nice 0 to
 * nice 1, it will get ~10% less CPU time than another CPU-bound task
 * that remained on nice 0.
 *
 * The "10% effect" is relative and cumulative: from _any_ nice level,
 * if you go up 1 level, it's -10% CPU usage, if you go down 1 level
 * it's +10% CPU usage. (to achieve that we use a multiplier of 1.25.
 * If a task goes up by ~10% and another task goes down by ~10% then
 * the relative distance between them is ~25%.)
 */</span>
</code></pre>
<p>The above comments doesn't make perfect sense to me.  But we can do a
few examples to understand the effect of nice levels.</p>
<p><strong>Example 1:</strong> One CPU with 2 running processes, <code>p1</code> and <code>p2</code>.  Both
processes have the default weight 1024.  Their CPU run times are</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>5</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = t_2 = 0.5T
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">5</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>When the weight of <code>p1</code> changed from 1024 to 820 (from nice 0 to
nice 1), their CPU run times become</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mn>8</mn><mn>2</mn><mn>0</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>4</mn><mn>4</mn><mn>4</mn><mn>7</mn><mi>T</mi><mo separator="true">,</mo><mspace width="1em"></mspace><mspace width="1em"></mspace><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><mfrac><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>5</mn><mn>5</mn><mn>5</mn><mn>3</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = \frac{820}{820+1024}T \approx 0.4447T,\quad\quad t_2 =
\frac{1024}{820+1024}T \approx 0.5553T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.09077em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">4</span><span class="mord mathrm">4</span><span class="mord mathrm">4</span><span class="mord mathrm">7</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mord mspace quad"></span><span class="mord mspace quad"></span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">5</span><span class="mord mathrm">5</span><span class="mord mathrm">5</span><span class="mord mathrm">3</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>So <code>p1</code> gets ~11% less CPU time and <code>p2</code> gets ~11% more CPU time.
The test for this example is <a href="priority-tests.html#test-1">here</a>.</p>
<p><strong>Example 2:</strong> One CPU with 4 running processes, from <code>p1</code> to <code>p4</code>.
All processes have the default weight.  The CPU run times are</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><msub><mi>t</mi><mn>3</mn></msub><mo>=</mo><msub><mi>t</mi><mn>4</mn></msub><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mn>5</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = t_2 = t_3 = t_4 = 0.25T
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">3</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">4</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>When the weight of <code>p1</code> changed from 1024 to 820 (from nice 0 to
nice1), their CPU run times become</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mn>8</mn><mn>2</mn><mn>0</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mn>1</mn><mn>0</mn><mn>7</mn><mi>T</mi><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><msub><mi>t</mi><mn>3</mn></msub><mo>=</mo><msub><mi>t</mi><mn>4</mn></msub><mo>=</mo><mfrac><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mn>6</mn><mn>3</mn><mn>1</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = \frac{820}{820+3\times1024}T \approx 0.2107T,\quad t_2 = t_3 =
t_4 = \frac{1024}{820+3\times1024}T \approx 0.2631T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.09077em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">7</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mord mspace quad"></span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">3</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">4</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord mathrm">6</span><span class="mord mathrm">3</span><span class="mord mathrm">1</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p><code>p1</code> gets ~16% less CPU time and the other processes get ~5% more
CPU time.  The test for this example is
<a href="priority-tests.html#test-2">here</a>.</p>
<h3 id="2.2.-data-structures" tabindex="-1"><a class="header-anchor" href="#2.2.-data-structures">2.2. Data structures</a></h3>
<p>The following lists the major data structures and the related fields.
Their connections are shown in the following <a href="#structs">figure</a>.</p>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rq</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span>   cfs<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>struct rq</code> is the per-CPU data structure that stores system run queue
information.  Its <code>cfs</code> field stores the root level CFS run queue
information.  The run queue info for realtime scheduler <code>rt_rq</code> and
deadline scheduler <code>dl_rq</code> are not shown here.</p>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">load_weight</span>      load<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>            nr_running<span class="token punctuation">;</span>
    u64                     min_vruntime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_root_cached</span>   tasks_timeline<span class="token punctuation">;</span>
    <span class="token comment">/*
     * 'curr' points to currently running entity on this cfs_rq.
     * It is set to NULL otherwise (i.e when none are currently running).
     */</span>
    <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span>     <span class="token operator">*</span>curr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">task_group</span>       <span class="token operator">*</span>tg<span class="token punctuation">;</span>    <span class="token comment">/* group that "owns" this runqueue */</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>struct cfs_rq</code> stores information of CFS run queue.  Each CPU has a
root level <code>cfs_rq</code>, embedded in <code>struct rq</code>.  Every task group also
has one <code>cfs_rq</code> per CPU.  The "queue" is implemented as a red-black
tree of <code>struct sched_entity</code>.  <code>struct cfs_rq</code> has the following
related fields:</p>
<ul>
<li>
<p><code>load</code>: the sum of <code>sched_entity</code> (or <code>se</code>) weights on the run
queue.</p>
</li>
<li>
<p><code>nr_running</code>: the number of <code>se</code> on the run queue.</p>
</li>
<li>
<p><code>min_vruntime</code>: the minimum <code>vruntime</code> of all <code>se</code> on the run queue.
This value is used to initialize the <code>vruntime</code> of a <code>se</code> when the
<code>se</code> is enqueued.</p>
</li>
<li>
<p><code>tasks_timeline</code>: the red-black tree's root node.</p>
</li>
<li>
<p><code>curr</code>: the currently running entity on this cfs_rq.</p>
</li>
<li>
<p><code>tg</code>: the task group that owns the <code>cfs_rq</code>.</p>
</li>
</ul>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sched_entity</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">load_weight</span>              load<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_node</span>                  run_node<span class="token punctuation">;</span>
    u64                             vruntime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span>             <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token comment">/* rq on which this entity is (to be) queued: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span>                   <span class="token operator">*</span>cfs_rq<span class="token punctuation">;</span>
    <span class="token comment">/* rq "owned" by this entity/group: */</span>
    <span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span>                   <span class="token operator">*</span>my_q<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span>             se<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">task_group</span>               <span class="token operator">*</span>sched_task_group<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">task_group</span> <span class="token punctuation">{</span>
    <span class="token comment">/* schedulable entities of this group on each CPU */</span>
    <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span>     <span class="token operator">*</span><span class="token operator">*</span>se<span class="token punctuation">;</span>
    <span class="token comment">/* runqueue "owned" by this group on each CPU */</span>
    <span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span>           <span class="token operator">*</span><span class="token operator">*</span>cfs_rq<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">task_group</span>       <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span>           shares<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><code>struct sched_entity</code> stores scheduling information.  Each <code>struct task_struct</code> contains an embedded <code>struct sched_entity</code>.  Also each
<code>struct task_group</code> contains pointers to a list of per-CPU <code>struct sched_entity</code>.</p>
<p><code>struct sched_entity</code> contains the following fields:</p>
<ul>
<li>
<p><code>load</code>: the weight of the entity.</p>
</li>
<li>
<p><code>run_node</code>: the red-black tree node.</p>
</li>
<li>
<p><code>vruntime</code>: the <code>vruntime</code> of the entity.</p>
</li>
<li>
<p><code>parent</code>: the <code>se</code> of the parent task group.</p>
</li>
<li>
<p><code>cfs_rq</code>: the CFS run queue that manages the <code>se</code>.</p>
</li>
<li>
<p><code>my_q</code>: for a task <code>se</code>, this field is <code>NULL</code>; for a task group
<code>se</code>, this field is the task group's <code>cfs_rq</code> on the same CPU.</p>
</li>
</ul>
<p><code>struct task_group</code> contains the following fields:</p>
<ul>
<li>
<p><code>se</code>: <code>se[i]</code> is the task groups's <code>sched_entity</code> data for <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>-th
CPU.</p>
</li>
<li>
<p><code>cfs_rq</code>: <code>cfs_rq[i]</code> is the task group's <code>cfs_rq</code> data for <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>-th
CPU.</p>
</li>
<li>
<p><code>parent</code>: the parent task group.</p>
</li>
<li>
<p><code>shares</code>: the task group <code>cpu.shares</code>, scaled by 1024 for fixed
point computation.</p>
</li>
</ul>
<p>The following figure shows an simple example of task group tree and
the corresponding kernel data structures.</p>
<p><a name="structs"></a></p>
<img src="/posts/2020-04-27-cfs-group/structs.png">
<p>As shown in the sub-figure at the bottom right, The system has a task
group <code>tg1</code> under the root task group.  Process <code>p1</code> belongs to <code>tg1</code>
and process <code>p2</code> belongs to the root task group.  Both <code>p1</code> and <code>p2</code>
are running on the <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>-th CPU.</p>
<p>The dashed lines mark the connection formed by red-black trees.</p>
<h3 id="2.3.-initializing-vruntime" tabindex="-1"><a class="header-anchor" href="#2.3.-initializing-vruntime">2.3. Initializing <code>vruntime</code></a></h3>
<p>When a <code>se</code> is added to a <code>cfs_rq</code>, the <code>se-&gt;vruntime</code> is initialized
using the <code>cfs_rq-&gt;min_vruntime</code>.  For example, the following is a
code trace for the <code>fork()</code> syscall:</p>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token function">_do_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">&gt;</span> p <span class="token operator">=</span> <span class="token function">copy_process</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> trace<span class="token punctuation">,</span> NUMA_NO_NODE<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token operator">--</span><span class="token operator">&gt;</span> retval <span class="token operator">=</span> <span class="token function">sched_fork</span><span class="token punctuation">(</span>clone_flags<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> p<span class="token operator">-&gt;</span>sched_class<span class="token operator">-&gt;</span><span class="token function">task_fork</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>       <span class="token comment">// task_fork_fair()</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> se<span class="token operator">-&gt;</span>vruntime <span class="token operator">=</span> curr<span class="token operator">-&gt;</span>vruntime  <span class="token comment">// se is child, curr is parent</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">place_entity</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">,</span> se<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> se<span class="token operator">-&gt;</span>vruntime <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>se<span class="token operator">-&gt;</span>vruntime<span class="token punctuation">,</span> cfs_rq<span class="token operator">-&gt;</span>min_vruntime<span class="token operator">+</span>slice<span class="token punctuation">)</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> se<span class="token operator">-&gt;</span>vruntime <span class="token operator">-=</span> cfs_rq<span class="token operator">-&gt;</span>min_vruntime      <span class="token comment">// (1)</span>
<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">wake_up_new_task</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">activate_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">,</span> ENQUEUE_NOCLOCK<span class="token punctuation">)</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">enqueue_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>  <span class="token comment">// enqueue_task_fair()</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">enqueue_entity</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">,</span> se<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> se<span class="token operator">-&gt;</span>vruntime <span class="token operator">+=</span> cfs_rq<span class="token operator">-&gt;</span>min_vruntime  <span class="token comment">// (2)</span>
</code></pre>
<p>In function <code>place_entity()</code>, <code>vruntime</code> of the child process is set
according to <code>min_vruntime</code> of the <code>cfs_rq</code>.  In (1), the <code>vruntime</code>
is counted as a delta.  And in (2), when enqueuing <code>se</code> of the child
process, the <code>vruntime</code> is set by adding the delta back to the new
<code>cfs_rq-&gt;min_vruntime</code>.</p>
<h3 id="2.4.-updating-vruntime" tabindex="-1"><a class="header-anchor" href="#2.4.-updating-vruntime">2.4. Updating <code>vruntime</code></a></h3>
<p>Function <code>update_curr()</code> is called at many places to update <code>vruntime</code>
of the current entity.  The follwoing shows the related code snippet:</p>
<div class="line-numbers">
<pre class="language-c" tabindex="0"><code class="language-c"><span class="line-numbers-row"></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_curr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span> <span class="token operator">*</span>cfs_rq<span class="token punctuation">)</span>
<span class="line-numbers-row"></span><span class="token punctuation">{</span>
<span class="line-numbers-row"></span>    <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span> <span class="token operator">*</span>curr <span class="token operator">=</span> cfs_rq<span class="token operator">-&gt;</span>curr<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    u64 now <span class="token operator">=</span> <span class="token function">rq_clock_task</span><span class="token punctuation">(</span><span class="token function">rq_of</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    u64 delta_exec<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>    delta_exec <span class="token operator">=</span> now <span class="token operator">-</span> curr<span class="token operator">-&gt;</span>exec_start<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    curr<span class="token operator">-&gt;</span>exec_start <span class="token operator">=</span> now<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    curr<span class="token operator">-&gt;</span>vruntime <span class="token operator">+=</span> <span class="token function">calc_delta_fair</span><span class="token punctuation">(</span>delta_exec<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    <span class="token function">update_min_vruntime</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span><span class="token punctuation">}</span></code></pre>
</div>
<p>In line 7, the new CPU time of the current entity is calculated as
<code>delta_exec</code>.  In line 9, <code>delta_exec</code> is scaled and added to
<code>vruntime</code>.  Finally in line 10, the <code>cfs_rq-&gt;min_vruntime</code> is updated
accordingly in <code>update_min_vruntime()</code>.</p>
<p>Function <code>calc_delta_fair()</code> multiplies <code>delta_exec</code> by a relative
weight factor and returns</p>
<pre class="language-text" tabindex="0"><code class="language-text">                              curr-&gt;load.weight
                delta_exec * ———————————————————
                                 NICE_0_LOAD
</code></pre>
<p><code>NICE_0_LOAD</code> is the default weight (1024) for nice level 0.  So for a
processe with the default nice level, its <code>vruntime</code> equals to its
physical CPU run time.</p>
<h3 id="2.5.-scheduling" tabindex="-1"><a class="header-anchor" href="#2.5.-scheduling">2.5. Scheduling</a></h3>
<p>The following shows the related code trace of function <code>__schedule()</code>:</p>
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token function">__schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">&gt;</span> next <span class="token operator">=</span> <span class="token function">pick_next_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rf<span class="token punctuation">)</span>  <span class="token comment">// pick_next_task_fair()</span>
<span class="token operator">--</span><span class="token operator">&gt;</span> rq <span class="token operator">=</span> <span class="token function">context_switch</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Function <code>pick_next_task_fair()</code> could be simplified as follows:</p>
<div class="line-numbers">
<pre class="language-c" tabindex="0"><code class="language-c"><span class="line-numbers-row"></span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>
<span class="line-numbers-row"></span><span class="token function">pick_next_task_fair</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rq</span> <span class="token operator">*</span>rq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>prev<span class="token punctuation">)</span>
<span class="line-numbers-row"></span><span class="token punctuation">{</span>
<span class="line-numbers-row"></span>    <span class="token keyword">struct</span> <span class="token class-name">cfs_rq</span> <span class="token operator">*</span>cfs_rq <span class="token operator">=</span> <span class="token operator">&amp;</span>rq<span class="token operator">-&gt;</span>cfs<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span> <span class="token operator">*</span>se<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>    <span class="token keyword">do</span> <span class="token punctuation">{</span>
<span class="line-numbers-row"></span>        <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span> <span class="token operator">*</span>curr <span class="token operator">=</span> cfs_rq<span class="token operator">-&gt;</span>curr<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>        se <span class="token operator">=</span> <span class="token function">pick_next_entity</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>        cfs_rq <span class="token operator">=</span> se<span class="token operator">-&gt;</span>my_q<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>cfs_rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>    p <span class="token operator">=</span> <span class="token function">task_of</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-row"></span>        <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span> <span class="token operator">*</span>pse <span class="token operator">=</span> <span class="token operator">&amp;</span>prev<span class="token operator">-&gt;</span>se<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>cfs_rq <span class="token operator">=</span> <span class="token function">is_same_group</span><span class="token punctuation">(</span>se<span class="token punctuation">,</span> pse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-row"></span>            <span class="token keyword">int</span> se_depth <span class="token operator">=</span> se<span class="token operator">-&gt;</span>depth<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>            <span class="token keyword">int</span> pse_depth <span class="token operator">=</span> pse<span class="token operator">-&gt;</span>depth<span class="token punctuation">;</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>se_depth <span class="token operator">&lt;=</span> pse_depth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-row"></span>                <span class="token function">put_prev_entity</span><span class="token punctuation">(</span><span class="token function">cfs_rq_of</span><span class="token punctuation">(</span>pse<span class="token punctuation">)</span><span class="token punctuation">,</span> pse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>                pse <span class="token operator">=</span> <span class="token function">parent_entity</span><span class="token punctuation">(</span>pse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>            <span class="token punctuation">}</span>
<span class="line-numbers-row"></span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>se_depth <span class="token operator">&gt;=</span> pse_depth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-row"></span>                <span class="token function">set_next_entity</span><span class="token punctuation">(</span><span class="token function">cfs_rq_of</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">,</span> se<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>                se <span class="token operator">=</span> <span class="token function">parent_entity</span><span class="token punctuation">(</span>se<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>            <span class="token punctuation">}</span>
<span class="line-numbers-row"></span>        <span class="token punctuation">}</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>        <span class="token function">put_prev_entity</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">,</span> pse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>        <span class="token function">set_next_entity</span><span class="token punctuation">(</span>cfs_rq<span class="token punctuation">,</span> se<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-row"></span>    <span class="token punctuation">}</span>
<span class="line-numbers-row"></span>
<span class="line-numbers-row"></span>    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="line-numbers-row"></span><span class="token punctuation">}</span></code></pre>
</div>
<p>The first loop from line 8 to 12 walks the tree of <code>cfs_rq</code> from top
to bottom to find a leaf <code>se</code> with the minimum <code>vruntime</code>.  The leaf
<code>se</code> belongs to a task which is retrieved in line 14.  Function
<code>pick_next_entity()</code> may take the leftmost entity from the red-black
tree.</p>
<p>The second loop from line 18 to 30 walks the tree from bottom to top
to find the common ancestor control group of the previous task and the
newly selected task.  The entities on the path from the previous task
to the common ancestor are marked as noncurrent, by setting their
corresponding <code>cfs_rq-&gt;curr</code> to <code>NULL</code>.  The entities on path from the
new task to the common ancestor are marked as current, by setting the
corresponding <code>cfs_rq-&gt;curr</code> to these entities.  These are done in
function <code>put_prev_entity()</code> and <code>set_next_entity()</code> respectively.</p>
<h2 id="3.-task-groups" tabindex="-1"><a class="header-anchor" href="#3.-task-groups">3. Task groups</a></h2>
<p>The weights of processes are defined by their nice values.  On the
other hand, the weights of task groups are defined in the groups'
<code>cpu.shares</code> files in <code>/sys/fs/cgroup/cpu/</code>.  The default value of
<code>cpu.shares</code> is 1024.</p>
<p>The <code>cpu.shares</code> is split up by the group's per-CPU entitiess.  Each
entity gets a portion of <code>cpu.shares</code> proportional to the task group's
running load on the CPU.  So for an entity of a task group on CPU <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mtext><mi mathvariant="normal">w</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">g</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">t</mi></mtext><mi>i</mi></msub><mo>=</mo><mfrac><mrow><msub><mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">d</mi></mtext><mi>i</mi></msub></mrow><mrow><mo>∑</mo><mtext><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">d</mi></mtext></mrow></mfrac><mtext><mi mathvariant="normal">s</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">s</mi></mtext></mrow><annotation encoding="application/x-tex">\text{weight}_i = \frac{\text{load}_i}{\sum \text{load}} \text{shares}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.37144em;"></span><span class="strut bottom" style="height:2.3074500000000002em;vertical-align:-0.93601em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm" style="margin-right:0.01389em;">w</span><span class="mord mathrm">e</span><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.01389em;">g</span><span class="mord mathrm">h</span><span class="mord mathrm">t</span></span><span class="vlist"><span style="top:0.24444em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">∑</span><span class="text mord textstyle cramped"><span class="mord mathrm">l</span><span class="mord mathrm">o</span><span class="mord mathrm">a</span><span class="mord mathrm">d</span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="text mord textstyle uncramped"><span class="mord mathrm">l</span><span class="mord mathrm">o</span><span class="mord mathrm">a</span><span class="mord mathrm">d</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm">s</span><span class="mord mathrm">h</span><span class="mord mathrm">a</span><span class="mord mathrm">r</span><span class="mord mathrm">e</span><span class="mord mathrm">s</span></span></span></span></span></span></p>
<p>Here, the "load" is different to system load average.  It is relative
to the sum of weights of tasks in a task group.  Some details of the
load calculation can be found in <a href="https://lwn.net/Articles/531853/">this lwn
article</a>.</p>
<p>As an example, in the <a href="#structs">previous figure</a>, if the host has 4
CPUs with the same load as in the figure, i.e. both <code>p1</code> and <code>p2</code> have
4 running threads/tasks distributed evenly on the 4 CPUs, then each
<code>sched_entity</code> of <code>tg1</code> has a weight of 256, and each <code>sched_entity</code>
of <code>p2</code> has a weight of 1024.  So <code>p2</code> takes 4 times more CPU time
than <code>p1</code>, even though they have the same nice values.</p>
<h3 id="3.1.-autogrouping" tabindex="-1"><a class="header-anchor" href="#3.1.-autogrouping">3.1. Autogrouping</a></h3>
<p>Linux has an autogrouping feature that automatically creates task
groups for sessions.  Some distributions have autogrouping enabled by
default.  So if you are running two processes in different ssh
sessions, changing the nice values of the processes does not affect
the their relative priorities.  See <a href="http://man7.org/linux/man-pages/man7/sched.7.html"><code>man 7 sched</code></a> for more
info about the autogroup feature.</p>
<h3 id="3.2.-cgroup-v2" tabindex="-1"><a class="header-anchor" href="#3.2.-cgroup-v2">3.2. Cgroup v2</a></h3>
<p>In cgroup v2, the <code>cpu.shares</code> is renamed to <code>cpu.weight</code>, which has a
default value of 100.  The value is rescaled to 1024 in the function
<code>cpu_weight_write_u64</code>.</p>

  </div>
</div>
<div class="vskip"></div>
<script src="https://utteranc.es/client.js" repo="mechpen/mechpen.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async="">
</script>


    </div>
  

</body></html>