<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<title>Linux CFS and task group – Mechpen</title>


<link rel="icon" type="image/png" href="/assets/favicon.png" />
<link rel="stylesheet" href="/assets/style.css" />

    
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" rel="stylesheet" />
    
    <link href="/assets/prism.css" rel="stylesheet" />
    
  </head>

  <body class="line-numbers">
    <div>
      <div class="container">
        <header class="masthead clearfix">
          <div class="site-info">
            <a href="/" class="site-name">Mechpen</a>
          </div>
          <nav>
	    <a href="/">posts</a>
	    <a href="/notes">notes</a>
	    <a href="/about">about</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <div class="post">
  <h1>Linux CFS and task group</h1>

  <div class="date">
    April 27, 2020
  </div>

  <div class="entry">
    <p>
I dived into the kernel scheduler code under
(<code>kernel/sched/</code>) to understand how CFS works and how the
task group <code>cpu.shares</code> value is used in CFS.
</p>
    <h2 id="1.-cfs">1. CFS <a class="header-anchor" href="#1.-cfs">¶</a></h2>
<h3 id="1.1.-concepts">1.1. Concepts <a class="header-anchor" href="#1.1.-concepts">¶</a></h3>
<p>In CFS, every running entity (process or group) has a virtual runtime
(<code>vruntime</code>) which accounts for the entity's CPU usage. The scheduling
goal of CFS is to keep the <code>vruntime</code> of all running entities to be
the same.</p>
<p>The <code>vruntime</code> is calculated by dividing the physical CPU run time of
the entity with a weight factor.  A high priority entity has a larger
weight than a low priority entity, thus the <code>vruntime</code> of a high
priority entity grows slower than that of a low priority entity.
Effectively, when both are running, the high priority entity is
allocated more phsical CPU time.</p>
<p>Assume a CPU has <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span> running entities.  Entity <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>E</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">E_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">E</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.05764em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> has weight <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>
and CPU time <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">t_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.61508em;"></span><span class="strut bottom" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">i=1, 2, ..., n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">2</span><span class="mpunct">,</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mpunct">,</span><span class="mord mathit">n</span></span></span></span> then</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mi>r</mi><mi>u</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>=</mo><mfrac><mrow><msub><mi>t</mi><mn>1</mn></msub></mrow><mrow><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac><mo>=</mo><mfrac><mrow><msub><mi>t</mi><mn>2</mn></msub></mrow><mrow><msub><mi>w</mi><mn>2</mn></msub></mrow></mfrac><mo>=</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>=</mo><mfrac><mrow><msub><mi>t</mi><mi>n</mi></msub></mrow><mrow><msub><mi>w</mi><mi>n</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">vruntime = \frac{t_1}{w_1} = \frac{t_2}{w_2} = ... = \frac{t_n}{w_n}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.29208em;"></span><span class="strut bottom" style="height:2.1280799999999997em;vertical-align:-0.8360000000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathit">e</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">n</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>Over any time period <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span>, we have:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><mrow><mo>∑</mo><mi>w</mi></mrow></mfrac><mi>T</mi></mrow><annotation encoding="application/x-tex">t_i = \frac{w_i}{\sum w}T
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.10756em;"></span><span class="strut bottom" style="height:2.04357em;vertical-align:-0.93601em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">∑</span><span class="mord mathit" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.02691em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<h3 id="1.2.-implementation-notes">1.2. Implementation notes <a class="header-anchor" href="#1.2.-implementation-notes">¶</a></h3>
<h4 id="1.2.1.-nice-level%2C-priority-and-weight">1.2.1. Nice level, priority and weight <a class="header-anchor" href="#1.2.1.-nice-level%2C-priority-and-weight">¶</a></h4>
<p>User can change the nice level of a process with the <code>nice()</code> syscall
or the <code>setpriority()</code> syscall.  nice levels are mapped to priority
values using the macro <code>NICE_TO_PRIO()</code>, and priority values are
mapped to weights using the lookup table <code>sched_prio_to_weight</code>.  The
following table shows these mappings:</p>
<table>
<thead>
<tr>
<th>nice level</th>
<th>priority</th>
<th>weight</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>−</mo><mn>2</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">-20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord">−</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span> (min)</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>8</mn><mn>8</mn><mn>7</mn><mn>6</mn><mn>1</mn><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mn>2</mn><mn>0</mn></mrow></msup></mrow><annotation encoding="application/x-tex">88761 \approx 1024 \times 1.25^{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">8</span><span class="mord mathrm">8</span><span class="mord mathrm">7</span><span class="mord mathrm">6</span><span class="mord mathrm">1</span><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>∈</mo><mo>[</mo><mo>−</mo><mn>1</mn><mn>9</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">n\in[-19, -1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">∈</span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mpunct">,</span><span class="mord">−</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>2</mn><mn>0</mn><mo>+</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">120 + n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathit">n</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mo>−</mo><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\approx 1024 \times 1.25^{-n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.771331em;"></span><span class="strut bottom" style="height:0.854661em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">0</span></span></span></span> (default)</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>2</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">120</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><annotation encoding="application/x-tex">1024</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>∈</mo><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mn>8</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">n\in[1, 18]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">∈</span><span class="mopen">[</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">1</span><span class="mord mathrm">8</span><span class="mclose">]</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>2</mn><mn>0</mn><mo>+</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">120 + n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathit">n</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mo>−</mo><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\approx 1024 \times 1.25^{-n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.771331em;"></span><span class="strut bottom" style="height:0.854661em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>9</mn></mrow><annotation encoding="application/x-tex">19</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">9</span></span></span></span> (max)</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>3</mn><mn>9</mn></mrow><annotation encoding="application/x-tex">139</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">3</span><span class="mord mathrm">9</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>5</mn><mo>≈</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>×</mo><mn>1</mn><mi mathvariant="normal">.</mi><mn>2</mn><msup><mn>5</mn><mrow><mo>−</mo><mn>1</mn><mn>9</mn></mrow></msup></mrow><annotation encoding="application/x-tex">15 \approx 1024 \times 1.25^{-19}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">5</span><span class="mrel">≈</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord"><span class="mord mathrm">5</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></td>
</tr>
</tbody>
</table>
<p>The comment above <code>sched_prio_to_weight</code> explains why 1.25 is used as
the base for weight calculation:</p>
<pre><code class="language-c">/*
 * Nice levels are multiplicative, with a gentle 10% change for every
 * nice level changed. I.e. when a CPU-bound task goes from nice 0 to
 * nice 1, it will get ~10% less CPU time than another CPU-bound task
 * that remained on nice 0.
 *
 * The &quot;10% effect&quot; is relative and cumulative: from _any_ nice level,
 * if you go up 1 level, it's -10% CPU usage, if you go down 1 level
 * it's +10% CPU usage. (to achieve that we use a multiplier of 1.25.
 * If a task goes up by ~10% and another task goes down by ~10% then
 * the relative distance between them is ~25%.)
 */
</code></pre>
<p>The above comments doesn't make perfect sense to me.  But we can do a
few examples to understand the effect of nice levels.</p>
<p><em>Example 1:</em> One CPU with 2 running processes, <code>p1</code> and <code>p2</code>.  Both
processes have the default weight 1024.  Their CPU run times are</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>5</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = t_2 = 0.5T
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">5</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>When the weight of <code>p1</code> changed from 1024 to 820 (from nice 0 to
nice1), their CPU run times are</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mn>8</mn><mn>2</mn><mn>0</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>4</mn><mn>4</mn><mn>4</mn><mn>7</mn><mi>T</mi><mo separator="true">,</mo><mspace width="1em"></mspace><mspace width="1em"></mspace><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><mfrac><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>5</mn><mn>5</mn><mn>5</mn><mn>3</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = \frac{820}{820+1024}T \approx 0.4447T,\quad\quad t_2 =
\frac{1024}{820+1024}T \approx 0.5553T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.09077em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">4</span><span class="mord mathrm">4</span><span class="mord mathrm">4</span><span class="mord mathrm">7</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mord mspace quad"></span><span class="mord mspace quad"></span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">5</span><span class="mord mathrm">5</span><span class="mord mathrm">5</span><span class="mord mathrm">3</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>So <code>p1</code> gets ~11% less CPU time and <code>p2</code> gets ~11% more CPU time.
The test for this example is <a href="priority-tests.html#test-1">here</a>.</p>
<p><em>Example 2:</em> One CPU with 4 running processes, from <code>p1</code> to <code>p4</code>.  All
processes have the default weight.  The CPU run times are</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><msub><mi>t</mi><mn>3</mn></msub><mo>=</mo><msub><mi>t</mi><mn>4</mn></msub><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mn>5</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = t_2 = t_3 = t_4 = 0.25T
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">3</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">4</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p>When the weight of <code>p1</code> changed from 1024 to 820 (from nice 0 to
nice1), their CPU run times are</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mn>1</mn></msub><mo>=</mo><mfrac><mrow><mn>8</mn><mn>2</mn><mn>0</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mn>1</mn><mn>0</mn><mn>7</mn><mi>T</mi><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>t</mi><mn>2</mn></msub><mo>=</mo><msub><mi>t</mi><mn>3</mn></msub><mo>=</mo><msub><mi>t</mi><mn>4</mn></msub><mo>=</mo><mfrac><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><mrow><mn>8</mn><mn>2</mn><mn>0</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow></mfrac><mi>T</mi><mo>≈</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mn>6</mn><mn>3</mn><mn>1</mn><mi>T</mi></mrow><annotation encoding="application/x-tex">t_1 = \frac{820}{820+3\times1024}T \approx 0.2107T,\quad t_2 = t_3 =
t_4 = \frac{1024}{820+3\times1024}T \approx 0.2631T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.09077em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">7</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mord mspace quad"></span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">3</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">4</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mbin">+</span><span class="mord mathrm">3</span><span class="mbin">×</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mrel">≈</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mord mathrm">6</span><span class="mord mathrm">3</span><span class="mord mathrm">1</span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></span></p>
<p><code>p1</code> gets ~16% less CPU time and the other processes get ~5% more
CPU time.  The test for this example is
<a href="priority-tests.html#test-2">here</a>.</p>
<h4 id="1.2.2.-data-structures">1.2.2. Data structures <a class="header-anchor" href="#1.2.2.-data-structures">¶</a></h4>
<pre><code class="language-c">struct rq {
        struct cfs_rq   cfs;
        ...
}
</code></pre>
<p><code>struct rq</code> is the per-CPU data structure that system run queue
information.  Its <code>cfs</code> field stores the root level CFS run queue
information.</p>
<pre><code class="language-c">struct cfs_rq {
        struct load_weight      load;
        unsigned int            nr_running;
        u64                     min_vruntime;
        struct rb_root_cached   tasks_timeline;
	/*
	 * 'curr' points to currently running entity on this cfs_rq.
	 * It is set to NULL otherwise (i.e when none are currently running).
	 */
	struct sched_entity	*curr;
	struct task_group       *tg;    /* group that &quot;owns&quot; this runqueue */
        ...
}
</code></pre>
<p><code>struct cfs_rq</code> stores information of CFS run queue.  Each CPU has a
root level <code>cfs_rq</code> data.  Also each task group has one <code>cfs_rq</code> for
each CPU.  The run queue is implemented as a red-black tree of <code>struct sched_entity</code>.  The fields of <code>struct cfs_rq</code> are as follows:</p>
<ul>
<li>
<p><code>load</code>: the sum of <code>sched_entity(se)</code> weights on the run queue.</p>
</li>
<li>
<p><code>nr_running</code>: the number of <code>se</code> on the run queue.</p>
</li>
<li>
<p><code>min_vruntime</code>: the minimum <code>vruntime</code> of all <code>se</code> on the run queue.
This value is used to initialize the <code>vruntime</code> of a <code>se</code> when the
<code>se</code> is enqueued.</p>
</li>
<li>
<p><code>tasks_timeline</code>: the red-black tree's root node.</p>
</li>
<li>
<p><code>curr</code>: the currently running entity on this cfs_rq.</p>
</li>
<li>
<p><code>tg</code>: the task group that owns the <code>cfs_rq</code>.</p>
</li>
</ul>
<pre><code class="language-c">struct sched_entity {
        struct load_weight              load;
        struct rb_node                  run_node;
        u64                             vruntime;
        struct sched_entity             *parent;
        /* rq on which this entity is (to be) queued: */
        struct cfs_rq                   *cfs_rq;
        /* rq &quot;owned&quot; by this entity/group: */
        struct cfs_rq                   *my_q;
        ...
};

struct task_struct {
        struct sched_entity             se;
        struct task_group               *sched_task_group;
        ...
}

struct task_group {
        /* schedulable entities of this group on each CPU */
        struct sched_entity     **se;
        /* runqueue &quot;owned&quot; by this group on each CPU */
        struct cfs_rq           **cfs_rq;
        struct task_group       *parent;
        unsigned long           shares;
        ...
};
</code></pre>
<p><code>struct sched_entity</code> stores scheduling information.  Each <code>struct task_struct</code> contains a <code>se</code> field of <code>struct sched_entity</code>.  Also
each <code>struct task_group</code> contains one <code>se</code> for each CPU.</p>
<p><code>struct sched_entity</code> contains the following fields:</p>
<ul>
<li>
<p><code>load</code>: the weight of the entity.</p>
</li>
<li>
<p><code>run_node</code>: the red-black tree node.</p>
</li>
<li>
<p><code>vruntime</code>: the <code>vruntime</code> of the entity.</p>
</li>
<li>
<p><code>parent</code>: the <code>se</code> of the parent task group.</p>
</li>
<li>
<p><code>cfs_rq</code>: the CFS run queue that manages the <code>se</code>.</p>
</li>
<li>
<p><code>my_q</code>: for a process <code>se</code>, this field is <code>NULL</code>; for a task group
<code>se</code>, this field is the task group's <code>cfs_rq</code> on the same CPU.</p>
</li>
</ul>
<p><code>struct task_group</code> contains the following fields:</p>
<ul>
<li>
<p><code>se</code>: <code>se[i]</code> is the task groups's <code>sched_entity</code> data for i-th CPU.</p>
</li>
<li>
<p><code>cfs_rq</code>: <code>cfs_rq[1]</code> is the task group's <code>cfs_rq</code> data for i-th CPU.</p>
</li>
<li>
<p><code>parent</code>: the parent task group.</p>
</li>
<li>
<p><code>shares</code>: the task group <code>cpu.shares</code>, scaled by 1024 for fixed
point computation.</p>
</li>
</ul>
<p>The following figure shows an simple example of task group tree and
the corresponding kernel data structures.</p>
<p><img src="structs.png" /></p>
<p>As shown in the gray sub-figure, The system has a task group <code>tg1</code>
under the root task group.  Process <code>p1</code> belongs to <code>tg1</code> and process
<code>p2</code> belongs to the root task group.  Both <code>p1</code> and <code>p2</code> are running
in the <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.65952em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span></span></span></span>-th CPU.</p>
<p>The dashed lines mark the connection formed by red-black trees.</p>
<h4 id="1.2.3.-initializing-vruntime">1.2.3. Initializing <code>vruntime</code> <a class="header-anchor" href="#1.2.3.-initializing-vruntime">¶</a></h4>
<p>When a <code>se</code> is added to a <code>cfs_rq</code>, the <code>se-&gt;vruntime</code> is initialized
using the <code>cfs_rq-&gt;min_vruntime</code>.  For example, the following is a
code trace for the <code>fork()</code> syscall:</p>
<pre><code class="language-c">_do_fork()
--&gt; p = copy_process(NULL, trace, NUMA_NO_NODE, args)
    --&gt; retval = sched_fork(clone_flags, p)
        --&gt; p-&gt;sched_class-&gt;task_fork(p)       // task_fork_fair()
            --&gt; se-&gt;vruntime = curr-&gt;vruntime  // se is child, curr is parent
            --&gt; place_entity(cfs_rq, se, 1)
                --&gt; se-&gt;vruntime = max(se-&gt;vruntime, cfs_rq-&gt;min_vruntime+slice)
            --&gt; se-&gt;vruntime -= cfs_rq-&gt;min_vruntime  // (1)
--&gt; wake_up_new_task(p)
    --&gt; activate_task(rq, p, ENQUEUE_NOCLOCK)
        --&gt; enqueue_task(rq, p, flags)  // enqueue_task_fair()
            --&gt; enqueue_entity(cfs_rq, se, flags)
                --&gt; se-&gt;vruntime += cfs_rq-&gt;min_vruntime  // (2)
</code></pre>
<p>In function <code>place_entity()</code>, <code>vruntime</code> of the child process is set
according to <code>min_vruntime</code> of the <code>cfs_rq</code>.  In (1), the <code>vruntime</code>
is counted as a delta.  And in (2), when enqueuing the child, the
<code>vruntime</code> is set by adding the delta and the new
<code>cfs_rq-&gt;min_vruntime</code>.</p>
<h4 id="1.2.4.-updating-vruntime">1.2.4. Updating <code>vruntime</code> <a class="header-anchor" href="#1.2.4.-updating-vruntime">¶</a></h4>
<p>Function <code>update_curr()</code> is called at many places to update <code>vruntime</code>
of the current entity.  The follwoing shows the related code snippet:</p>
<pre><code class="language-c">static void update_curr(struct cfs_rq *cfs_rq)
{
	struct sched_entity *curr = cfs_rq-&gt;curr;
	u64 now = rq_clock_task(rq_of(cfs_rq));
	u64 delta_exec;

	delta_exec = now - curr-&gt;exec_start;
	curr-&gt;exec_start = now;
	curr-&gt;vruntime += calc_delta_fair(delta_exec, curr);
	update_min_vruntime(cfs_rq);
}
</code></pre>
<p>The new CPU execution time is calculated as <code>delta_exec</code>.  Then
<code>delta_exec</code> is scaled to get the <code>vruntime</code> increment.</p>
<p>Function <code>calc_delta_fair()</code> multiplies <code>delta_exec</code> by a relative
scale factor and returns</p>
<pre><code class="language-text">		              curr-&gt;load.weight
		delta_exec * ———————————————————
		                 NICE_0_LOAD
</code></pre>
<p><code>NICE_0_LOAD</code> is the default weight (1024) for nice level 0.  So for
any processe with the default nice level, its <code>vruntime</code> equals to its
physical CPU run time.</p>
<p>Finally, <code>min_vruntime</code> of the run queue is updated accordingly in
function <code>update_min_vruntime()</code>.</p>
<h4 id="1.2.5.-scheduling">1.2.5. Scheduling <a class="header-anchor" href="#1.2.5.-scheduling">¶</a></h4>
<p>The following shows the code trace of function <code>__schedule()</code>:</p>
<pre><code class="language-c">__schedule()
--&gt; next = pick_next_task(rq, prev, &amp;rf)  // pick_next_task_fair()
--&gt; rq = context_switch(rq, prev, next, &amp;rf);
</code></pre>
<p>Function <code>pick_next_task_fair()</code> could be simplified as follows:</p>
<pre><code class="language-c">struct task_struct *
pick_next_task_fair(struct rq *rq, struct task_struct *prev, struct rq_flags *rf)
{
	struct cfs_rq *cfs_rq = &amp;rq-&gt;cfs;
	struct sched_entity *se;
	struct task_struct *p;

	do {
		struct sched_entity *curr = cfs_rq-&gt;curr;
		se = pick_next_entity(cfs_rq, curr);
		cfs_rq = group_cfs_rq(se);
	} while (cfs_rq);

	p = task_of(se);
	if (prev != p) {
		struct sched_entity *pse = &amp;prev-&gt;se;

		while (!(cfs_rq = is_same_group(se, pse))) {
			int se_depth = se-&gt;depth;
			int pse_depth = pse-&gt;depth;

			if (se_depth &lt;= pse_depth) {
				put_prev_entity(cfs_rq_of(pse), pse);
				pse = parent_entity(pse);
			}
			if (se_depth &gt;= pse_depth) {
				set_next_entity(cfs_rq_of(se), se);
				se = parent_entity(se);
			}
		}

		put_prev_entity(cfs_rq, pse);
		set_next_entity(cfs_rq, se);
	}

	return p;
}
</code></pre>
<h4 id="1.2.6.-autogrouping">1.2.6. Autogrouping <a class="header-anchor" href="#1.2.6.-autogrouping">¶</a></h4>
<p>You may be suprised when setting process priority does not take any
effect.  This is normally due to the autogroup feature.  When this
feature is enabled, a new CPU control group is created for each new
session.  If two processes belong to different groups, their
priorities are overridden by group weights.</p>
<p>See <a href="http://man7.org/linux/man-pages/man7/sched.7.html"><code>man 7 sched</code></a>
for more info about the autogroup feature.  See the following
<a href="#2.-task-groups">section</a> for more info about group weights.</p>
<h2 id="2.-task-groups">2. Task groups <a class="header-anchor" href="#2.-task-groups">¶</a></h2>

  </div>
</div>
<div class="vskip"></div>
<script src="https://utteranc.es/client.js"
        repo="mechpen/mechpen.github.io"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


    </div>
  </body>
</html>
