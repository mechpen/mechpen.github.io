<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<title>TCP sequence number and 3-way handshake â€“ Mechpen</title>


<link rel="icon" type="image/png" href="/assets/favicon.png">

    <script type="text/javascript">

  var currentTheme = localStorage.getItem('theme')

  function setTheme(theme) {
    if (theme === "dark") {
      document.documentElement.setAttribute('theme', 'dark')
    } else {
      document.documentElement.setAttribute('theme', 'light')
    }
  }
  setTheme(currentTheme)

  function switchTheme() {
    if (currentTheme == "dark") {
      currentTheme = ""
    } else {
      currentTheme = "dark"
    }
    localStorage.setItem('theme', currentTheme)
    setTheme(currentTheme)
  }

</script>

    
    
    <link href="/assets/prism.css" rel="stylesheet" />
    
    <link href="/assets/style.css" rel="stylesheet" />
  </head>

  <body>
    <div>
      <div class="container">
        <header class="masthead clearfix">
          <div class="site-info">
            <a href="/" class="site-name">Mechpen</a>
          </div>
          <nav>
	    <a href="/">posts</a>
	    <a href="/notes">notes</a>
	    <a href="/about">about</a>
            <a id="light-mode" onclick="switchTheme()">light mode</a>
            <a id="dark-mode" onclick="switchTheme()">dark mode</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      
<div class="post">
  <h1>TCP sequence number and 3-way handshake</h1>

  <div class="date">
    June 26, 2019
  </div>

  <div class="entry">
    <p>One challenge of TCP is to handle stale packets. Packets from previous connections may get delayed in the network and interfere with new connections. To solve this problem, TCP enforces the following rule on sequence numbers.</p>
    <p><em>Between 2 TCP sockets, only one outstanding sequence number could
exist in the network.</em></p>
<p>We only consider unidirectional traffic here to simplify the
discussion.  The rule could be stated more specifically as:</p>
<p><em>Let T be the maximum network round trip delay, any sequence number
can be used at most once during T for all connections between 2
sockets.</em></p>
<p>T is limited by packet ttl and network topology. The default value for
T is 120 seconds according to <a href="https://www.pearson.com/us/higher-education/program/Tanenbaum-Computer-Networks-5th-Edition/PGM270019.html">Tanenbaum</a>. If this rule is violated,
bad things could happen.  The following figure shows one such
scenario.</p>
<div class="img"><?xml version='1.0' encoding='UTF-8'?>
<!-- This file was generated by dvisvgm 2.7 -->
<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='331.8555pt' height='353.508pt' viewBox='19.9258 0 331.8555 353.508'>
<defs>
<font id='cmr10' horiz-adv-x='0'>
<font-face font-family='cmr10' units-per-em='1000' ascent='750' descent='250'/>
<glyph unicode='+' horiz-adv-x='777' vert-adv-y='777' glyph-name='plus' d='M409 230H688C702 230 721 230 721 250S702 270 688 270H409V550C409 564 409 583 389 583S369 564 369 550V270H89C75 270 56 270 56 250S75 230 89 230H369V-50C369-64 369-83 389-83S409-64 409-50V230Z'/>
<glyph unicode=',' horiz-adv-x='277' vert-adv-y='277' glyph-name='comma' d='M203 1C203 65 179 106 139 106C104 106 86 79 86 53S103 0 139 0C155 0 167 6 177 14L179 16C180 16 181 15 181 1C181-63 153-124 109-171C103-177 102-178 102-182C102-189 107-193 112-193C124-193 203-114 203 1Z'/>
<glyph unicode='-' horiz-adv-x='333' vert-adv-y='333' glyph-name='hyphen' d='M276 187V245H11V187H276Z'/>
<glyph unicode='0' horiz-adv-x='500' vert-adv-y='500' glyph-name='zero' d='M460 320C460 400 455 480 420 554C374 650 292 666 250 666C190 666 117 640 76 547C44 478 39 400 39 320C39 245 43 155 84 79C127-2 200-22 249-22C303-22 379-1 423 94C455 163 460 241 460 320ZM249 0C210 0 151 25 133 121C122 181 122 273 122 332C122 396 122 462 130 516C149 635 224 644 249 644C282 644 348 626 367 527C377 471 377 395 377 332C377 257 377 189 366 125C351 30 294 0 249 0Z'/>
<glyph unicode='1' horiz-adv-x='500' vert-adv-y='500' glyph-name='one' d='M294 640C294 664 294 666 271 666C209 602 121 602 89 602V571C109 571 168 571 220 597V79C220 43 217 31 127 31H95V0C130 3 217 3 257 3S384 3 419 0V31H387C297 31 294 42 294 79V640Z'/>
<glyph unicode='2' horiz-adv-x='500' vert-adv-y='500' glyph-name='two' d='M127 77L233 180C389 318 449 372 449 472C449 586 359 666 237 666C124 666 50 574 50 485C50 429 100 429 103 429C120 429 155 441 155 482C155 508 137 534 102 534C94 534 92 534 89 533C112 598 166 635 224 635C315 635 358 554 358 472C358 392 308 313 253 251L61 37C50 26 50 24 50 0H421L449 174H424C419 144 412 100 402 85C395 77 329 77 307 77H127Z'/>
<glyph unicode='3' horiz-adv-x='500' vert-adv-y='500' glyph-name='three' d='M290 352C372 379 430 449 430 528C430 610 342 666 246 666C145 666 69 606 69 530C69 497 91 478 120 478C151 478 171 500 171 529C171 579 124 579 109 579C140 628 206 641 242 641C283 641 338 619 338 529C338 517 336 459 310 415C280 367 246 364 221 363C213 362 189 360 182 360C174 359 167 358 167 348C167 337 174 337 191 337H235C317 337 354 269 354 171C354 35 285 6 241 6C198 6 123 23 88 82C123 77 154 99 154 137C154 173 127 193 98 193C74 193 42 179 42 135C42 44 135-22 244-22C366-22 457 69 457 171C457 253 394 331 290 352Z'/>
<glyph unicode='4' horiz-adv-x='500' vert-adv-y='500' glyph-name='four' d='M294 165V78C294 42 292 31 218 31H197V0C238 3 290 3 332 3S427 3 468 0V31H447C373 31 371 42 371 78V165H471V196H371V651C371 671 371 677 355 677C346 677 343 677 335 665L28 196V165H294ZM300 196H56L300 569V196Z'/>
<glyph unicode='5' horiz-adv-x='500' vert-adv-y='500' glyph-name='five' d='M449 201C449 320 367 420 259 420C211 420 168 404 132 369V564C152 558 185 551 217 551C340 551 410 642 410 655C410 661 407 666 400 666C399 666 397 666 392 663C372 654 323 634 256 634C216 634 170 641 123 662C115 665 113 665 111 665C101 665 101 657 101 641V345C101 327 101 319 115 319C122 319 124 322 128 328C139 344 176 398 257 398C309 398 334 352 342 334C358 297 360 258 360 208C360 173 360 113 336 71C312 32 275 6 229 6C156 6 99 59 82 118C85 117 88 116 99 116C132 116 149 141 149 165S132 214 99 214C85 214 50 207 50 161C50 75 119-22 231-22C347-22 449 74 449 201Z'/>
<glyph unicode='=' horiz-adv-x='777' vert-adv-y='777' glyph-name='equal' d='M687 327C702 327 721 327 721 347S702 367 688 367H89C75 367 56 367 56 347S75 327 90 327H687ZM688 133C702 133 721 133 721 153S702 173 687 173H90C75 173 56 173 56 153S75 133 89 133H688Z'/>
<glyph unicode='A' horiz-adv-x='750' vert-adv-y='750' glyph-name='A' d='M398 696C393 709 391 716 375 716S356 710 351 696L144 98C126 47 86 32 32 31V0C55 1 98 3 134 3C165 3 217 1 249 0V31C199 31 174 56 174 82C174 85 175 95 176 97L222 228H469L522 75C523 71 525 65 525 61C525 31 469 31 442 31V0C478 3 548 3 586 3C629 3 675 2 717 0V31H699C639 31 625 38 614 71L398 696ZM345 584L458 259H233L345 584Z'/>
<glyph unicode='C' horiz-adv-x='722' vert-adv-y='722' glyph-name='C' d='M56 342C56 135 218-22 404-22C567-22 665 117 665 233C665 243 665 250 652 250C641 250 641 244 640 234C632 91 525 9 416 9C355 9 159 43 159 341C159 640 354 674 415 674C524 674 613 583 633 437C635 423 635 420 649 420C665 420 665 423 665 444V681C665 698 665 705 654 705C650 705 646 705 638 693L588 619C551 655 500 705 404 705C217 705 56 546 56 342Z'/>
<glyph unicode='K' horiz-adv-x='777' vert-adv-y='777' glyph-name='K' d='M400 419L580 592C588 600 641 651 722 652V683C696 680 664 680 637 680C601 680 544 680 510 683V652C550 651 556 628 556 619C556 603 546 593 538 586L225 287V605C225 641 227 652 304 652H328V683C293 680 219 680 181 680S68 680 33 683V652H57C134 652 136 641 136 605V78C136 42 134 31 57 31H33V0C68 3 142 3 180 3S293 3 328 0V31H304C227 31 225 42 225 78V253L341 363L522 95C528 86 537 73 537 61C537 31 498 31 478 31V0C513 3 583 3 621 3C656 3 694 2 736 0V31C682 31 661 35 631 79L400 419Z'/>
<glyph unicode='N' horiz-adv-x='750' vert-adv-y='750' glyph-name='N' d='M232 670C223 682 222 683 203 683H33V652H62C77 652 97 651 112 650C135 647 136 646 136 627V105C136 78 136 31 33 31V0C68 1 117 3 150 3S232 1 267 0V31C164 31 164 78 164 105V625C169 620 170 619 174 613L582 13C591 1 592 0 599 0C613 0 613 7 613 26V578C613 605 613 652 716 652V683C681 682 632 680 599 680S517 682 482 683V652C585 652 585 605 585 578V151L232 670Z'/>
<glyph unicode='R' horiz-adv-x='736' vert-adv-y='736' glyph-name='R' d='M224 353V612C224 635 224 647 246 650C256 652 285 652 305 652C395 652 507 648 507 503C507 434 483 353 335 353H224ZM435 340C532 364 610 425 610 503C610 599 496 683 349 683H35V652H59C136 652 138 641 138 605V78C138 42 136 31 59 31H35V0C71 3 142 3 181 3S291 3 327 0V31H303C226 31 224 42 224 78V331H339C355 331 397 331 432 297C470 261 470 230 470 163C470 98 470 58 511 20C552-16 607-22 637-22C715-22 732 60 732 88C732 94 732 105 719 105C708 105 708 96 707 89C701 18 666 0 641 0C592 0 584 51 570 144L557 224C539 288 490 321 435 340Z'/>
<glyph unicode='S' horiz-adv-x='555' vert-adv-y='555' glyph-name='S' d='M349 388L221 419C159 434 120 488 120 546C120 616 174 677 252 677C419 677 441 513 447 468C448 462 448 456 459 456C472 456 472 461 472 480V681C472 698 472 705 461 705C454 705 453 704 446 692L411 635C381 664 340 705 251 705C140 705 56 617 56 511C56 428 109 355 187 328C198 324 249 312 319 295C346 288 376 281 404 244C425 218 435 185 435 152C435 81 385 9 301 9C272 9 196 14 143 63C85 117 82 181 81 217C80 227 72 227 69 227C56 227 56 220 56 202V2C56-15 56-22 67-22C74-22 75-20 82-9C82-8 85-5 118 48C149 14 213-22 302-22C419-22 499 76 499 186C499 286 433 368 349 388Z'/>
<glyph unicode='Y' horiz-adv-x='750' vert-adv-y='750' glyph-name='Y' d='M610 587C647 648 706 652 738 652V683C707 681 667 680 640 680C609 680 551 682 525 683V652C566 652 582 633 582 613C582 602 576 589 572 583L407 315L226 610C219 620 219 622 219 627C219 648 244 652 289 652V683C253 680 180 680 141 680C99 680 53 681 11 683V652H29C97 652 105 641 121 615L331 273V78C331 42 329 31 252 31H228V0C264 3 335 3 374 3S484 3 520 0V31H497C420 31 417 41 417 80V273L610 587Z'/>
<glyph unicode='a' horiz-adv-x='500' vert-adv-y='500' glyph-name='a' d='M333 76C337 36 364-6 411-6C432-6 493 8 493 89V145H468V89C468 31 443 25 432 25C399 25 395 70 395 75V275C395 317 395 356 359 393C320 432 270 448 222 448C140 448 71 401 71 335C71 305 91 288 117 288C145 288 163 308 163 334C163 346 158 379 112 380C139 415 188 426 220 426C269 426 326 387 326 298V261C275 258 205 255 142 225C67 191 42 139 42 95C42 14 139-11 202-11C268-11 314 29 333 76ZM326 240V140C326 45 254 11 209 11C160 11 119 46 119 96C119 151 161 234 326 240Z'/>
<glyph unicode='c' horiz-adv-x='444' vert-adv-y='444' glyph-name='c' d='M117 218C117 381 199 423 252 423C261 423 324 422 359 386C318 383 312 353 312 340C312 314 330 294 358 294C384 294 404 311 404 341C404 409 328 448 251 448C126 448 34 340 34 216C34 88 133-11 249-11C383-11 415 109 415 119S405 129 402 129C393 129 391 125 389 119C360 26 295 14 258 14C205 14 117 57 117 218Z'/>
<glyph unicode='d' horiz-adv-x='555' vert-adv-y='555' glyph-name='d' d='M380 55V-11L527 0V31C457 31 449 38 449 87V694L305 683V652C375 652 383 645 383 596V380C354 416 311 442 257 442C139 442 34 344 34 215C34 88 132-11 246-11C310-11 355 23 380 55ZM380 323V118C380 100 380 98 369 81C339 33 294 11 251 11C206 11 170 37 146 75C120 116 117 173 117 214C117 251 119 311 148 356C169 387 207 420 261 420C296 420 338 405 369 360C380 343 380 341 380 323Z'/>
<glyph unicode='e' horiz-adv-x='444' vert-adv-y='444' glyph-name='e' d='M112 252C118 401 202 426 236 426C339 426 349 291 349 252H112ZM111 231H390C412 231 415 231 415 252C415 351 361 448 236 448C120 448 28 345 28 220C28 86 133-11 248-11C370-11 415 100 415 119C415 129 407 131 402 131C393 131 391 125 389 117C354 14 264 14 254 14C204 14 164 44 141 81C111 129 111 195 111 231Z'/>
<glyph unicode='i' horiz-adv-x='277' vert-adv-y='277' glyph-name='i' d='M177 442L37 431V400C102 400 111 394 111 345V76C111 31 100 31 33 31V0C65 1 119 3 143 3C178 3 213 1 247 0V31C181 31 177 36 177 75V442ZM181 616C181 648 156 669 128 669C97 669 75 642 75 616C75 589 97 563 128 563C156 563 181 584 181 616Z'/>
<glyph unicode='k' horiz-adv-x='527' vert-adv-y='527' glyph-name='k' d='M106 76C106 31 95 31 28 31V0C61 1 108 3 137 3C167 3 207 2 247 0V31C180 31 169 31 169 76V179L233 234C310 128 352 72 352 54C352 35 335 31 316 31V0C344 1 403 3 424 3C453 3 482 2 511 0V31C474 31 452 31 414 84L287 263C286 265 281 271 281 274C281 278 352 338 362 346C425 397 467 399 488 400V431C459 428 446 428 418 428C382 428 320 430 306 431V400C325 399 335 388 335 375C335 355 321 343 313 336L172 214V694L28 683V652C98 652 106 645 106 596V76Z'/>
<glyph unicode='n' horiz-adv-x='555' vert-adv-y='555' glyph-name='n' d='M110 344V76C110 31 99 31 32 31V0C67 1 118 3 145 3C171 3 223 1 257 0V31C190 31 179 31 179 76V260C179 364 250 420 314 420C377 420 388 366 388 309V76C388 31 377 31 310 31V0C345 1 396 3 423 3C449 3 501 1 535 0V31C483 31 458 31 457 61V252C457 338 457 369 426 405C412 422 379 442 321 442C248 442 201 399 173 337V442L32 431V400C102 400 110 393 110 344Z'/>
<glyph unicode='q' horiz-adv-x='527' vert-adv-y='527' glyph-name='q' d='M380 61V-118C380-163 369-163 302-163V-194C336-193 388-191 414-191C441-191 492-193 527-194V-163C460-163 449-163 449-118V442H427L389 351C376 379 335 442 255 442C139 442 34 345 34 215C34 90 131-11 247-11C317-11 358 32 380 61ZM383 277V136C383 104 365 76 343 52C330 38 298 11 251 11C178 11 117 100 117 215C117 334 187 417 261 417C341 417 383 330 383 277Z'/>
<glyph unicode='r' horiz-adv-x='391' vert-adv-y='391' glyph-name='r' d='M167 332V442L28 431V400C98 400 106 393 106 344V76C106 31 95 31 28 31V0C67 1 114 3 142 3C182 3 229 3 269 0V31H248C174 31 172 42 172 78V232C172 331 214 420 290 420C297 420 299 420 301 419C298 418 278 406 278 380C278 352 299 337 321 337C339 337 364 349 364 381S333 442 290 442C217 442 181 375 167 332Z'/>
<glyph unicode='s' horiz-adv-x='394' vert-adv-y='394' glyph-name='s' d='M208 194C230 190 312 174 312 102C312 51 277 11 199 11C115 11 79 68 60 153C57 166 56 170 46 170C33 170 33 163 33 145V13C33-4 33-11 44-11C49-11 50-10 69 9C71 11 71 13 89 32C133-10 178-11 199-11C314-11 360 56 360 128C360 181 330 211 318 223C285 255 246 263 204 271C148 282 81 295 81 353C81 388 107 429 193 429C303 429 308 339 310 308C311 299 320 299 322 299C335 299 335 304 335 323V424C335 441 335 448 324 448C319 448 317 448 304 436C301 432 291 423 287 420C249 448 208 448 193 448C71 448 33 381 33 325C33 290 49 262 76 240C108 214 136 208 208 194Z'/>
<glyph unicode='t' horiz-adv-x='388' vert-adv-y='388' glyph-name='t' d='M173 400H316V431H173V615H148C147 533 117 426 19 422V400H104V124C104 1 197-11 233-11C304-11 332 60 332 124V181H307V126C307 52 277 14 240 14C173 14 173 105 173 122V400Z'/>
<glyph unicode='v' horiz-adv-x='527' vert-adv-y='527' glyph-name='v' d='M416 333C425 356 442 399 508 400V431C485 429 456 428 433 428C409 428 363 430 346 431V400C383 399 394 376 394 357C394 348 392 344 388 333L286 78L174 357C168 370 168 372 168 374C168 400 207 400 225 400V431C195 430 139 428 116 428C89 428 49 429 19 431V400C82 400 86 394 99 363L243 8C249-6 251-11 264-11S281-2 285 8L416 333Z'/>
</font>
</defs>
<style type='text/css'>
<![CDATA[text.f0 {font-family:cmr10;font-size:9.96264px}
]]>
</style>
<g id='page1'>
<path d='M19.9258 353.508V0H351.7813V353.508Z' fill='#fff'/>
<path d='M42.214843 23.0273V349.016' stroke='#000' fill='none' stroke-width='.3985' stroke-miterlimit='10'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 -14.6813 -36.848)'>Sender</text>
<path d='M325.6833 23.0273V349.016' stroke='#000' fill='none' stroke-width='.3985' stroke-miterlimit='10'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 264.9817 -36.848)'>Receiver</text>
<path d='M268.9923 37.2031L266.7223 38.1953L264.4573 39.1875L262.1873 40.1797L259.9223 41.1719L257.6523 42.16406L255.3863 43.15625L253.1173 44.14844L250.8513 45.14063L248.5823 46.13281L246.3163 47.12109L244.0473 48.11328L242.7653 51.394532L236.2033 48.82813L233.6363 55.38672L227.0783 52.82031L224.5113 59.37891L221.2303 58.09766L218.9613 59.08984L216.6953 60.08203L214.4253 61.07422L212.1603 62.0664L209.8903 63.0586L207.6253 64.0508L205.3553 65.043L203.0903 66.0352L200.8203 67.0273L198.5543 68.0195L196.2853 69.0078L195.0043 72.2891L188.4453 69.7227L185.8753 76.2813L179.3163 73.7148L176.7503 80.2773L173.4683 78.9922L171.2033 79.9844L168.9333 80.9766L166.6683 81.9688L164.3983 82.9609L162.1333 83.9531L159.8633 84.9453L157.5973 85.9375L155.3283 86.9297L153.0623 87.9219L150.7933 88.9141L148.5273 89.9063L147.2423 93.1836L140.6836 90.6172L138.1172 97.1758L131.5547 94.6094L128.9883 101.1719L125.707 99.8867L123.4414 100.8789L121.1719 101.8711L118.9062 102.8633L116.6406 103.8555L114.3711 104.8477L112.1055 105.8398L109.8359 106.832L107.5703 107.8242L105.3008 108.8164L103.0352 109.8086L100.7656 110.8008L99.4805 114.0781L92.9219 111.5117L90.3555 118.0703L83.7969 115.5039L81.2266 122.0664L77.9492 120.7813L75.6797 121.7734L73.4141 122.7656L71.1445 123.7578L68.8789 124.75L66.6094 125.7422L64.3437 126.7344L62.0742 127.7266L45.98047 134.7695' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M43.257787 135.960599L47.691381 135.734032L45.80076 134.847315L46.433571 132.859028Z'/>
<path d='M43.257787 135.960599L47.691381 135.734032L45.80076 134.847315L46.433571 132.859028Z' stroke='#000' fill='none' stroke-width='.796967' stroke-miterlimit='10'/>
<path d='M272.3793 43.73438H284.0003V30.6719H272.3793Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 233.4827 -10.9632)'>1</text>
<path d='M249.7183 25.0234L159.7153 64.3984L165.9253 78.5938L255.9293 39.2188Z' fill='#fff'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(.9161 -.40079 .40079 .9161 107.596661 42.301617)'>SYN-ACK,ack=N+1</text>
<path d='M268.9923 93.8945L266.7223 94.8867L264.4573 95.8789L262.1873 96.8711L259.9223 97.8633L257.6523 98.8555L255.3863 99.8477L253.1173 100.8398L250.8513 101.832L248.5823 102.8242L246.3163 103.8164L244.0473 104.8086L242.7653 108.0898L236.2033 105.5234L233.6363 112.082L227.0783 109.5156L224.5113 116.0742L221.2303 114.7891L218.9613 115.7813L216.6953 116.7734L214.4253 117.7656L212.1603 118.7578L209.8903 119.75L207.6253 120.7422L205.3553 121.7344L203.0903 122.7266L200.8203 123.7188L198.5543 124.7109L196.2853 125.7031L195.0043 128.9844L188.4453 126.418L185.8753 132.9766L179.3163 130.4102L176.7503 136.9688L173.4683 135.6875L171.2033 136.6797L168.9333 137.668L166.6683 138.6602L164.3983 139.6523L162.1333 140.6445L159.8633 141.6367L157.5973 142.6289L155.3283 143.6211L153.0623 144.6133L150.7933 145.6055L148.5273 146.5977L147.2423 149.8789L140.6836 147.3125L138.1172 153.871L131.5547 151.3047L128.9883 157.863L125.707 156.582L123.4414 157.574L121.1719 158.566L118.9062 159.555L116.6406 160.547L114.3711 161.539L112.1055 162.531L109.8359 163.523L107.5703 164.516L105.3008 165.508L103.0352 166.5L100.7656 167.492L99.4805 170.773L92.9219 168.207L90.3555 174.766L83.7969 172.199L81.2266 178.758L77.9492 177.477L75.6797 178.469L73.4141 179.461L71.1445 180.453L68.8789 181.445L66.6094 182.434L64.3437 183.426L62.0742 184.418L45.98047 191.461' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M43.2578 192.656275L47.691388 192.42972L45.800768 191.543003L46.433582 189.550807Z'/>
<path d='M43.2578 192.656275L47.691388 192.42972L45.800768 191.543003L46.433582 189.550807Z' stroke='#000' fill='none' stroke-width='.796967' stroke-miterlimit='10'/>
<path d='M272.3793 100.4258H284.0003V87.3672H272.3793Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 233.4827 45.7304)'>2</text>
<path d='M249.7183 81.7188L176.9573 113.5508L183.1683 127.7461L255.9293 95.9141Z' fill='#fff'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(.9161 -.40079 .40079 .9161 124.836661 91.453317)'>ACK,ack=N+10</text>
<path d='M42.214843 108.0703L321.8673 219.93' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M324.62935 221.035217L321.359808 218.035215L322.055134 220.00397L320.191848 220.949267Z'/>
<path d='M324.62935 221.035217L321.359808 218.035215L322.055134 220.00397L320.191848 220.949267Z' stroke='#000' fill='none' stroke-width='.796977' stroke-miterlimit='10'/>
<path d='M27.207 114.6016H38.82812V101.5391H27.207Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 -11.6893 59.904)'>3</text>
<path d='M109.75 114.8633L55.2305 93.0547L49.51562 107.3398L104.0352 129.1484Z' fill='#fff'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(.92844 .37137 -.37137 .92844 34.434504 40.315599)'>SYN,seq=N</text>
<path d='M42.214843 164.762L321.8673 276.625' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M324.629329 277.730884L321.359791 274.726968L322.055128 276.699627L320.191835 277.644942Z'/>
<path d='M324.629329 277.730884L321.359791 274.726968L322.055128 276.699627L320.191835 277.644942Z' stroke='#000' fill='none' stroke-width='.796977' stroke-miterlimit='10'/>
<path d='M27.207 171.293H38.82812V158.234H27.207Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 -11.6893 116.597)'>4</text>
<path d='M143.9653 185.125L55.2695 149.6484L49.51562 164.035L138.2109 199.512Z' fill='#fff'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(.92844 .37137 -.37137 .92844 34.434504 97.008599)'>ACK,seq=N+1,data</text>
<path d='M325.6833 221.457L46.03125 333.316' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M43.269513 334.421686L47.710918 334.33965L45.847631 333.390422L46.542956 331.42169Z'/>
<path d='M43.269513 334.421686L47.710918 334.33965L45.847631 333.390422L46.542956 331.42169Z' stroke='#000' fill='none' stroke-width='.796977' stroke-miterlimit='10'/>
<path d='M329.0703 227.988H340.6953V214.926H329.0703Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(1 0 0 1 290.1757 173.291)'>5</text>
<path d='M304.1293 209.742L212.9143 246.227L218.6683 260.613L309.8833 224.129Z' fill='#fff'/>
<text class='f0' x='42.216338' y='51.376005' transform='matrix(.92844 -.37137 .37137 .92844 161.525193 222.477334)'>SYN-ACK,ack=N+1</text>
</g>
</svg></div>
<p>Packets 1 and 2 are stale packets from a previous connection.  The
sender re-uses initial sequence number N in packet 3, before the stale
packets are gone.  The sender completes 3-way handshake and sends data
in packet 4.  When the sender receives packet 2, it falsely assumes
that 9 bytes are delivered to the receiver.</p>
<p>I am not sure how the sequence number rule is implemented in practice.</p>
<p><a href="https://tools.ietf.org/html/rfc793#section-3.3">RFC 793</a> recommends using a persistent clock counter that increments
about every 4 microseconds.  This method is subject to <a href="https://en.wikipedia.org/wiki/TCP_sequence_prediction_attack">sequence
prediction attack</a> and is not used anymore.</p>
<p>Linux computes initial sequence numbers by adding a per-boot random
number to a persistent clock counter.  This random number could
decrease after reboots, so the resulting sequence numbers could
decrease, and potentially break the above rule.  See the following
section for details of Linux sequence number implementation.</p>
<p>As a side note, TCP connections use random ephemeral ports for source
ports.  It's rare that multiple connections happen between 2 TCP
sockets during a short time period.  However, TCP dost not prevent a
user from specifying a fixed source port for all connections.  The
randomness of ports is not a requirement of TCP.</p>
<h2 id="3-way-handshake">3-way handshake <a class="header-anchor" href="#3-way-handshake" aria-hidden="true">Â¶</a></h2>
<p>Assume the sequence number rule is satisfied, there's still one
problem.  When a host receives a SYN packet, it needs to figure out
whether this packet is stale or not, then it could discard the stale
SYN packet without setting up a connection.  The 3-way handshake is
designed to help validate SYN packets.  For example, in the following
figure, the stale SYN packet 1 could not complete 3-way handshake
because of the RST packet 3.</p>
<div class="img"><?xml version='1.0' encoding='UTF-8'?>
<!-- This file was generated by dvisvgm 2.7 -->
<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='331.8555pt' height='242.9527pt' viewBox='19.9258 0 331.8555 242.9527'>
<defs>
<font id='cmr10' horiz-adv-x='0'>
<font-face font-family='cmr10' units-per-em='1000' ascent='750' descent='250'/>
<glyph unicode='+' horiz-adv-x='777' vert-adv-y='777' glyph-name='plus' d='M409 230H688C702 230 721 230 721 250S702 270 688 270H409V550C409 564 409 583 389 583S369 564 369 550V270H89C75 270 56 270 56 250S75 230 89 230H369V-50C369-64 369-83 389-83S409-64 409-50V230Z'/>
<glyph unicode=',' horiz-adv-x='277' vert-adv-y='277' glyph-name='comma' d='M203 1C203 65 179 106 139 106C104 106 86 79 86 53S103 0 139 0C155 0 167 6 177 14L179 16C180 16 181 15 181 1C181-63 153-124 109-171C103-177 102-178 102-182C102-189 107-193 112-193C124-193 203-114 203 1Z'/>
<glyph unicode='-' horiz-adv-x='333' vert-adv-y='333' glyph-name='hyphen' d='M276 187V245H11V187H276Z'/>
<glyph unicode='1' horiz-adv-x='500' vert-adv-y='500' glyph-name='one' d='M294 640C294 664 294 666 271 666C209 602 121 602 89 602V571C109 571 168 571 220 597V79C220 43 217 31 127 31H95V0C130 3 217 3 257 3S384 3 419 0V31H387C297 31 294 42 294 79V640Z'/>
<glyph unicode='2' horiz-adv-x='500' vert-adv-y='500' glyph-name='two' d='M127 77L233 180C389 318 449 372 449 472C449 586 359 666 237 666C124 666 50 574 50 485C50 429 100 429 103 429C120 429 155 441 155 482C155 508 137 534 102 534C94 534 92 534 89 533C112 598 166 635 224 635C315 635 358 554 358 472C358 392 308 313 253 251L61 37C50 26 50 24 50 0H421L449 174H424C419 144 412 100 402 85C395 77 329 77 307 77H127Z'/>
<glyph unicode='3' horiz-adv-x='500' vert-adv-y='500' glyph-name='three' d='M290 352C372 379 430 449 430 528C430 610 342 666 246 666C145 666 69 606 69 530C69 497 91 478 120 478C151 478 171 500 171 529C171 579 124 579 109 579C140 628 206 641 242 641C283 641 338 619 338 529C338 517 336 459 310 415C280 367 246 364 221 363C213 362 189 360 182 360C174 359 167 358 167 348C167 337 174 337 191 337H235C317 337 354 269 354 171C354 35 285 6 241 6C198 6 123 23 88 82C123 77 154 99 154 137C154 173 127 193 98 193C74 193 42 179 42 135C42 44 135-22 244-22C366-22 457 69 457 171C457 253 394 331 290 352Z'/>
<glyph unicode='=' horiz-adv-x='777' vert-adv-y='777' glyph-name='equal' d='M687 327C702 327 721 327 721 347S702 367 688 367H89C75 367 56 367 56 347S75 327 90 327H687ZM688 133C702 133 721 133 721 153S702 173 687 173H90C75 173 56 173 56 153S75 133 89 133H688Z'/>
<glyph unicode='A' horiz-adv-x='750' vert-adv-y='750' glyph-name='A' d='M398 696C393 709 391 716 375 716S356 710 351 696L144 98C126 47 86 32 32 31V0C55 1 98 3 134 3C165 3 217 1 249 0V31C199 31 174 56 174 82C174 85 175 95 176 97L222 228H469L522 75C523 71 525 65 525 61C525 31 469 31 442 31V0C478 3 548 3 586 3C629 3 675 2 717 0V31H699C639 31 625 38 614 71L398 696ZM345 584L458 259H233L345 584Z'/>
<glyph unicode='C' horiz-adv-x='722' vert-adv-y='722' glyph-name='C' d='M56 342C56 135 218-22 404-22C567-22 665 117 665 233C665 243 665 250 652 250C641 250 641 244 640 234C632 91 525 9 416 9C355 9 159 43 159 341C159 640 354 674 415 674C524 674 613 583 633 437C635 423 635 420 649 420C665 420 665 423 665 444V681C665 698 665 705 654 705C650 705 646 705 638 693L588 619C551 655 500 705 404 705C217 705 56 546 56 342Z'/>
<glyph unicode='K' horiz-adv-x='777' vert-adv-y='777' glyph-name='K' d='M400 419L580 592C588 600 641 651 722 652V683C696 680 664 680 637 680C601 680 544 680 510 683V652C550 651 556 628 556 619C556 603 546 593 538 586L225 287V605C225 641 227 652 304 652H328V683C293 680 219 680 181 680S68 680 33 683V652H57C134 652 136 641 136 605V78C136 42 134 31 57 31H33V0C68 3 142 3 180 3S293 3 328 0V31H304C227 31 225 42 225 78V253L341 363L522 95C528 86 537 73 537 61C537 31 498 31 478 31V0C513 3 583 3 621 3C656 3 694 2 736 0V31C682 31 661 35 631 79L400 419Z'/>
<glyph unicode='N' horiz-adv-x='750' vert-adv-y='750' glyph-name='N' d='M232 670C223 682 222 683 203 683H33V652H62C77 652 97 651 112 650C135 647 136 646 136 627V105C136 78 136 31 33 31V0C68 1 117 3 150 3S232 1 267 0V31C164 31 164 78 164 105V625C169 620 170 619 174 613L582 13C591 1 592 0 599 0C613 0 613 7 613 26V578C613 605 613 652 716 652V683C681 682 632 680 599 680S517 682 482 683V652C585 652 585 605 585 578V151L232 670Z'/>
<glyph unicode='R' horiz-adv-x='736' vert-adv-y='736' glyph-name='R' d='M224 353V612C224 635 224 647 246 650C256 652 285 652 305 652C395 652 507 648 507 503C507 434 483 353 335 353H224ZM435 340C532 364 610 425 610 503C610 599 496 683 349 683H35V652H59C136 652 138 641 138 605V78C138 42 136 31 59 31H35V0C71 3 142 3 181 3S291 3 327 0V31H303C226 31 224 42 224 78V331H339C355 331 397 331 432 297C470 261 470 230 470 163C470 98 470 58 511 20C552-16 607-22 637-22C715-22 732 60 732 88C732 94 732 105 719 105C708 105 708 96 707 89C701 18 666 0 641 0C592 0 584 51 570 144L557 224C539 288 490 321 435 340Z'/>
<glyph unicode='S' horiz-adv-x='555' vert-adv-y='555' glyph-name='S' d='M349 388L221 419C159 434 120 488 120 546C120 616 174 677 252 677C419 677 441 513 447 468C448 462 448 456 459 456C472 456 472 461 472 480V681C472 698 472 705 461 705C454 705 453 704 446 692L411 635C381 664 340 705 251 705C140 705 56 617 56 511C56 428 109 355 187 328C198 324 249 312 319 295C346 288 376 281 404 244C425 218 435 185 435 152C435 81 385 9 301 9C272 9 196 14 143 63C85 117 82 181 81 217C80 227 72 227 69 227C56 227 56 220 56 202V2C56-15 56-22 67-22C74-22 75-20 82-9C82-8 85-5 118 48C149 14 213-22 302-22C419-22 499 76 499 186C499 286 433 368 349 388Z'/>
<glyph unicode='T' horiz-adv-x='722' vert-adv-y='722' glyph-name='T' d='M666 677H55L36 452H61C75 613 90 646 241 646C259 646 285 646 295 644C316 640 316 629 316 606V79C316 45 316 31 211 31H171V0C212 3 314 3 360 3S509 3 550 0V31H510C405 31 405 45 405 79V606C405 626 405 640 423 644C434 646 461 646 480 646C631 646 646 613 660 452H685L666 677Z'/>
<glyph unicode='Y' horiz-adv-x='750' vert-adv-y='750' glyph-name='Y' d='M610 587C647 648 706 652 738 652V683C707 681 667 680 640 680C609 680 551 682 525 683V652C566 652 582 633 582 613C582 602 576 589 572 583L407 315L226 610C219 620 219 622 219 627C219 648 244 652 289 652V683C253 680 180 680 141 680C99 680 53 681 11 683V652H29C97 652 105 641 121 615L331 273V78C331 42 329 31 252 31H228V0C264 3 335 3 374 3S484 3 520 0V31H497C420 31 417 41 417 80V273L610 587Z'/>
<glyph unicode='a' horiz-adv-x='500' vert-adv-y='500' glyph-name='a' d='M333 76C337 36 364-6 411-6C432-6 493 8 493 89V145H468V89C468 31 443 25 432 25C399 25 395 70 395 75V275C395 317 395 356 359 393C320 432 270 448 222 448C140 448 71 401 71 335C71 305 91 288 117 288C145 288 163 308 163 334C163 346 158 379 112 380C139 415 188 426 220 426C269 426 326 387 326 298V261C275 258 205 255 142 225C67 191 42 139 42 95C42 14 139-11 202-11C268-11 314 29 333 76ZM326 240V140C326 45 254 11 209 11C160 11 119 46 119 96C119 151 161 234 326 240Z'/>
<glyph unicode='c' horiz-adv-x='444' vert-adv-y='444' glyph-name='c' d='M117 218C117 381 199 423 252 423C261 423 324 422 359 386C318 383 312 353 312 340C312 314 330 294 358 294C384 294 404 311 404 341C404 409 328 448 251 448C126 448 34 340 34 216C34 88 133-11 249-11C383-11 415 109 415 119S405 129 402 129C393 129 391 125 389 119C360 26 295 14 258 14C205 14 117 57 117 218Z'/>
<glyph unicode='d' horiz-adv-x='555' vert-adv-y='555' glyph-name='d' d='M380 55V-11L527 0V31C457 31 449 38 449 87V694L305 683V652C375 652 383 645 383 596V380C354 416 311 442 257 442C139 442 34 344 34 215C34 88 132-11 246-11C310-11 355 23 380 55ZM380 323V118C380 100 380 98 369 81C339 33 294 11 251 11C206 11 170 37 146 75C120 116 117 173 117 214C117 251 119 311 148 356C169 387 207 420 261 420C296 420 338 405 369 360C380 343 380 341 380 323Z'/>
<glyph unicode='e' horiz-adv-x='444' vert-adv-y='444' glyph-name='e' d='M112 252C118 401 202 426 236 426C339 426 349 291 349 252H112ZM111 231H390C412 231 415 231 415 252C415 351 361 448 236 448C120 448 28 345 28 220C28 86 133-11 248-11C370-11 415 100 415 119C415 129 407 131 402 131C393 131 391 125 389 117C354 14 264 14 254 14C204 14 164 44 141 81C111 129 111 195 111 231Z'/>
<glyph unicode='i' horiz-adv-x='277' vert-adv-y='277' glyph-name='i' d='M177 442L37 431V400C102 400 111 394 111 345V76C111 31 100 31 33 31V0C65 1 119 3 143 3C178 3 213 1 247 0V31C181 31 177 36 177 75V442ZM181 616C181 648 156 669 128 669C97 669 75 642 75 616C75 589 97 563 128 563C156 563 181 584 181 616Z'/>
<glyph unicode='k' horiz-adv-x='527' vert-adv-y='527' glyph-name='k' d='M106 76C106 31 95 31 28 31V0C61 1 108 3 137 3C167 3 207 2 247 0V31C180 31 169 31 169 76V179L233 234C310 128 352 72 352 54C352 35 335 31 316 31V0C344 1 403 3 424 3C453 3 482 2 511 0V31C474 31 452 31 414 84L287 263C286 265 281 271 281 274C281 278 352 338 362 346C425 397 467 399 488 400V431C459 428 446 428 418 428C382 428 320 430 306 431V400C325 399 335 388 335 375C335 355 321 343 313 336L172 214V694L28 683V652C98 652 106 645 106 596V76Z'/>
<glyph unicode='n' horiz-adv-x='555' vert-adv-y='555' glyph-name='n' d='M110 344V76C110 31 99 31 32 31V0C67 1 118 3 145 3C171 3 223 1 257 0V31C190 31 179 31 179 76V260C179 364 250 420 314 420C377 420 388 366 388 309V76C388 31 377 31 310 31V0C345 1 396 3 423 3C449 3 501 1 535 0V31C483 31 458 31 457 61V252C457 338 457 369 426 405C412 422 379 442 321 442C248 442 201 399 173 337V442L32 431V400C102 400 110 393 110 344Z'/>
<glyph unicode='q' horiz-adv-x='527' vert-adv-y='527' glyph-name='q' d='M380 61V-118C380-163 369-163 302-163V-194C336-193 388-191 414-191C441-191 492-193 527-194V-163C460-163 449-163 449-118V442H427L389 351C376 379 335 442 255 442C139 442 34 345 34 215C34 90 131-11 247-11C317-11 358 32 380 61ZM383 277V136C383 104 365 76 343 52C330 38 298 11 251 11C178 11 117 100 117 215C117 334 187 417 261 417C341 417 383 330 383 277Z'/>
<glyph unicode='r' horiz-adv-x='391' vert-adv-y='391' glyph-name='r' d='M167 332V442L28 431V400C98 400 106 393 106 344V76C106 31 95 31 28 31V0C67 1 114 3 142 3C182 3 229 3 269 0V31H248C174 31 172 42 172 78V232C172 331 214 420 290 420C297 420 299 420 301 419C298 418 278 406 278 380C278 352 299 337 321 337C339 337 364 349 364 381S333 442 290 442C217 442 181 375 167 332Z'/>
<glyph unicode='s' horiz-adv-x='394' vert-adv-y='394' glyph-name='s' d='M208 194C230 190 312 174 312 102C312 51 277 11 199 11C115 11 79 68 60 153C57 166 56 170 46 170C33 170 33 163 33 145V13C33-4 33-11 44-11C49-11 50-10 69 9C71 11 71 13 89 32C133-10 178-11 199-11C314-11 360 56 360 128C360 181 330 211 318 223C285 255 246 263 204 271C148 282 81 295 81 353C81 388 107 429 193 429C303 429 308 339 310 308C311 299 320 299 322 299C335 299 335 304 335 323V424C335 441 335 448 324 448C319 448 317 448 304 436C301 432 291 423 287 420C249 448 208 448 193 448C71 448 33 381 33 325C33 290 49 262 76 240C108 214 136 208 208 194Z'/>
<glyph unicode='v' horiz-adv-x='527' vert-adv-y='527' glyph-name='v' d='M416 333C425 356 442 399 508 400V431C485 429 456 428 433 428C409 428 363 430 346 431V400C383 399 394 376 394 357C394 348 392 344 388 333L286 78L174 357C168 370 168 372 168 374C168 400 207 400 225 400V431C195 430 139 428 116 428C89 428 49 429 19 431V400C82 400 86 394 99 363L243 8C249-6 251-11 264-11S281-2 285 8L416 333Z'/>
</font>
</defs>
<style type='text/css'>
<![CDATA[text.f0 {font-family:cmr10;font-size:9.96264px}
]]>
</style>
<g id='page1'>
<path d='M19.9258 242.9527V0H351.7813V242.9527Z' fill='#fff'/>
<path d='M42.214843 23.0313V238.4647' stroke='#000' fill='none' stroke-width='.3985' stroke-miterlimit='10'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(1 0 0 1 -14.6813 31.1841)'>Sender</text>
<path d='M325.6833 23.0313V238.4647' stroke='#000' fill='none' stroke-width='.3985' stroke-miterlimit='10'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(1 0 0 1 264.9817 31.1841)'>Receiver</text>
<path d='M98.9102 51.375L101.1758 51.832L103.4453 52.2852L105.7109 52.7383L107.9805 53.1914L110.2461 53.6445L112.5156 54.0977L114.7852 54.5508L117.0508 55.0039L119.3203 55.457L121.5859 55.9102L123.8555 56.3672L126.1211 56.8203L129.0508 54.8672L132.9609 60.7266L138.8203 56.8203L142.7303 62.6797L148.5903 58.7734L150.5433 61.7031L152.8123 62.1563L155.0783 62.6094L157.3473 63.0625L159.6133 63.5156L161.8833 63.9727L164.1483 64.4258L166.4183 64.8789L168.6833 65.332L170.9533 65.7852L173.2183 66.2383L175.4883 66.6914L177.7543 67.1445L180.6873 65.1914L184.5933 71.0547L190.4533 67.1445L194.3633 73.0078L200.2223 69.0977L202.1753 72.0313L204.4453 72.4844L206.7113 72.9375L208.9803 73.3906L211.2503 73.8438L213.5153 74.2969L215.7853 74.75L218.0503 75.2031L220.3203 75.6602L222.5863 76.1133L224.8553 76.5664L227.1213 77.0195L229.3903 77.4727L232.3203 75.5195L236.2263 81.3789L242.0903 77.4727L245.9963 83.332L251.8593 79.4258L253.8123 82.3555L256.0783 82.8086L258.3473 83.2656L260.6133 83.7187L262.8833 84.1717L265.1483 84.6247L267.4183 85.0777L269.6833 85.5317L271.9533 85.9847L274.2183 86.4377L276.4883 86.8907L278.7543 87.3437L281.0233 87.8007L283.9533 85.8437L287.8593 91.7067L293.7223 87.8007L297.6293 93.6597L303.4923 89.7537L305.4453 92.6837L321.6523 95.9257' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M324.570654 96.507828L320.805007 94.156263L321.847993 95.964855L320.191744 97.234386Z'/>
<path d='M324.570654 96.507828L320.805007 94.156263L321.847993 95.964855L320.191744 97.234386Z' stroke='#000' fill='none' stroke-width='.796974' stroke-miterlimit='10'/>
<path d='M83.8984 57.9063H95.5234V44.8477H83.8984Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(1 0 0 1 45.0043 71.2424)'>1</text>
<path d='M171.9023 46.832L114.3203 35.3164L111.3047 50.4023L168.8863 61.918Z' fill='#fff'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(.98055 .1961 -.1961 .98055 70.929703 53.949938)'>SYN,seq=N</text>
<path d='M325.6833 96.7307L46.24609 152.6207' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M43.328142 153.203049L47.710951 153.929615L46.050797 152.660083L47.093771 150.847588Z'/>
<path d='M43.328142 153.203049L47.710951 153.929615L46.050797 152.660083L47.093771 150.847588Z' stroke='#000' fill='none' stroke-width='.796984' stroke-miterlimit='10'/>
<path d='M329.0703 103.2617H340.6953V90.1997H329.0703Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(1 0 0 1 290.1757 116.5974)'>2</text>
<path d='M307.4183 81.1289L211.0823 100.3947L214.1213 115.5897L310.4573 96.3247Z' fill='#fff'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(.98055 -.1961 .1961 .98055 178.218911 134.392971)'>SYN-ACK,ack=N+1</text>
<path d='M42.214843 153.4257L321.6523 209.3127' stroke='#000' fill='none' stroke-width='.79701' stroke-miterlimit='10'/>
<path d='M324.570403 209.898739L320.808673 207.543262L321.847737 209.351852L320.191479 210.621381Z'/>
<path d='M324.570403 209.898739L320.808673 207.543262L321.847737 209.351852L320.191479 210.621381Z' stroke='#000' fill='none' stroke-width='.796984' stroke-miterlimit='10'/>
<path d='M27.207 159.9567H38.82812V146.8947H27.207Z' fill='#ff0'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(1 0 0 1 -11.6893 173.2913)'>3</text>
<path d='M130.1211 151.8637L60.4648 137.9297L57.4453 153.0157L127.1016 166.9497Z' fill='#fff'/>
<text class='f0' x='42.216338' y='-16.655286' transform='matrix(.98055 .1961 -.1961 .98055 17.071303 156.565738)'>RST,seq=N+1</text>
</g>
</svg></div>
<p>Can we attach data in the first SYN or SYN-ACK packets to reduce the
connection time?  Theoretically yes according to <a href="Tomlin75.pdf">Tomlinson</a>.  However,
an application cannot accept outstanding data until completion of the
handshake.  There are several problems with this, for example, SYN
flood attack.</p>
<h2 id="initial-sequence-number-in-linux">Initial Sequence Number in Linux <a class="header-anchor" href="#initial-sequence-number-in-linux" aria-hidden="true">Â¶</a></h2>
<p>In Linux the initial sequence number for a TCP connection is computed
by function <code>secure_tcp_seq()</code>.</p>
<pre class="language-c"><code class="language-c">u32 <span class="token function">secure_tcp_seq</span><span class="token punctuation">(</span>__be32 saddr<span class="token punctuation">,</span> __be32 daddr<span class="token punctuation">,</span>
		   __be16 sport<span class="token punctuation">,</span> __be16 dport<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u32 hash<span class="token punctuation">;</span>

	<span class="token function">net_secret_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	hash <span class="token operator">=</span> <span class="token function">siphash_3u32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__force u32<span class="token punctuation">)</span>saddr<span class="token punctuation">,</span> <span class="token punctuation">(</span>__force u32<span class="token punctuation">)</span>daddr<span class="token punctuation">,</span>
			    <span class="token punctuation">(</span>__force u32<span class="token punctuation">)</span>sport <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token operator">|</span> <span class="token punctuation">(</span>__force u32<span class="token punctuation">)</span>dport<span class="token punctuation">,</span>
			    <span class="token operator">&amp;</span>net_secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">seq_scale</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token function">net_secret_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">net_get_random_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>net_secret<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>net_secret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> u32 <span class="token function">seq_scale</span><span class="token punctuation">(</span>u32 seq<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/*
	 *	As close as possible to RFC 793, which
	 *	suggests using a 250 kHz clock.
	 *	Further reading shows this assumes 2 Mb/s networks.
	 *	For 10 Mb/s Ethernet, a 1 MHz clock is appropriate.
	 *	For 10 Gb/s Ethernet, a 1 GHz clock should be ok, but
	 *	we also need to limit the resolution so that the u32 seq
	 *	overlaps less than one time per MSL (2 minutes).
	 *	Choosing a clock of 64 ns period is OK. (period of 274 s)
	 */</span>
	<span class="token keyword">return</span> seq <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">ktime_get_real_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The function <code>secure_tcp_seq()</code> first gets a per-boot random value
<code>net_secret</code>, computes a hash with this random number, and then adds
the hash to a clock counter (<code>ktime_get_real_ns()</code>) to get the initial
sequence number.</p>
<p>During a boot session, the hash for a connection is constant, so the
initial sequence number of each connection grows (module 2^32) with
time.  After reboot, the new hash could be smaller than the old hash,
making it possible to re-use a recent sequence number.</p>
<p>It's interesting to understand the calculations in the comments of
function <code>seq_scale()</code>.  The basic idea is that the number of bytes
been sent must increase slower than the sequence number increment.
Otherwise, some bytes could be labeled with sequence numbers that are
used in future connections.  So for 2 Mbps network speed, the clock
counter needs to grow faster than 2M/8 = 250 kHz.</p>

  </div>
</div>
<div class="vskip"></div>
<script src="https://utteranc.es/client.js"
        repo="mechpen/mechpen.github.io"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

    </div>
  </body>
</html>
